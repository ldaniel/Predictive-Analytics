<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>The random forest on loan’s report</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<script src="site_libs/plotly-binding-4.9.0/plotly.js"></script>
<script src="site_libs/typedarray-0.1/typedarray.min.js"></script>
<link href="site_libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="site_libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="site_libs/plotly-htmlwidgets-css-1.46.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="site_libs/plotly-main-1.46.1/plotly-latest.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">FGV MBA</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hand-holding-usd"></span>
     
    Business Case
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_about_the_data.html">About the Data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Initial Analysis</li>
    <li>
      <a href="02_data_preparation.html">Data Preparation</a>
    </li>
    <li>
      <a href="03_exploration_report.html">Data Exploration</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-invoice"></span>
     
    Model's Reports
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Analytical Methods</li>
    <li>
      <a href="04_logistic_regression_report.html">Logistic Regression Report</a>
    </li>
    <li>
      <a href="05_decision_tree_report.html">Decision Tree Report</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Ensembe Methods</li>
    <li>
      <a href="06_boosting_report.html">Boosting Report</a>
    </li>
    <li>
      <a href="07_random_forest_report.html">Random Forest Report</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-invoice-dollar"></span>
     
    Final Report
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="08_conclusion.html">Conclusion</a>
    </li>
    <li>
      <a href="09_references.html">References</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">The random forest on loan’s report</h1>
<h4 class="date">August, 2019</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#objective"><span class="toc-section-number">1</span> Objective</a></li>
<li><a href="#modeling"><span class="toc-section-number">2</span> Modeling</a><ul>
<li><a href="#dataset-preparation"><span class="toc-section-number">2.1</span> Dataset preparation</a></li>
<li><a href="#variable-selection"><span class="toc-section-number">2.2</span> Variable selection</a></li>
<li><a href="#sample-split-into-test-and-training-data"><span class="toc-section-number">2.3</span> Sample split into Test and Training Data</a></li>
</ul></li>
<li><a href="#selecting-the-best-parameters-values-for-the-random-forest"><span class="toc-section-number">3</span> Selecting the best parameters values for the Random Forest</a></li>
<li><a href="#interpreting-model-output"><span class="toc-section-number">4</span> Interpreting model output</a></li>
<li><a href="#evaluating-the-model-performance"><span class="toc-section-number">5</span> Evaluating the model performance</a><ul>
<li><a href="#getting-performance-measures"><span class="toc-section-number">5.1</span> Getting Performance Measures</a></li>
<li><a href="#evaluating-classification-performance"><span class="toc-section-number">5.2</span> Evaluating classification performance</a></li>
</ul></li>
</ul>
</div>

<div id="objective" class="section level1">
<h1><span class="header-section-number">1</span> Objective</h1>
<p>The goal of this session is to fit a Random Forest model on Loan data aiming to predict the probability of delinquency for each contract.</p>
<p>Random forest, in essence, consists of a large set of individual decision trees operating as an ensemble. Therefore, each individual tree in the random forest spits out a class prediction and the class with the most votes becomes our model’s prediction.</p>
<blockquote>
The fundamental concept behind random forest is a simple but powerful one — the wisdom of crowds. In data science speak, the reason that the random forest model works so well is: A large number of relatively uncorrelated models (trees) operating as a committee will outperform any of the individual constituent models.
<footer>
— Tony Yiu
</footer>
</blockquote>
<p>The RF algorithm is a supervised algorithm that, even though it can be used for regression purposes, it was initially conceived as a classification tool.</p>
<p>The method follows the same concept as a decision tree but with the power of the crowd. So, basically, instead of using one big, deep and complex tree, the method relies on multiple randomly different (in multiple ways) trees voting for a class. This method usually perform better better than one very well trained tree even if, individually, the trees are not as good classifiers, thus refering to the forementioned wisdom of the crowds.</p>
<blockquote>
Random forest thrives even in scenarios, when there is an abundance of chaos, i.e. many predictors. It’s hard to know which predictor is important and which is not. All the other traditional statistical techniques might fail or struggle when we have an incredibly high number of independent variables.
<footer>
— Pranov Mishra
</footer>
</blockquote>
<p>Because of the voting system inherent to the method it is often said to be democratic algorithm.</p>
<blockquote>
Now, if you think for a second, this is the way direct democracy works: each voter has access to a subset of the information and only sees that subset from a particular perspective (their own unique perspective). By using a majority vote, we are actually implementing a Random Forest.
<footer>
— Pablo Duboue
</footer>
</blockquote>
<hr />
</div>
<div id="modeling" class="section level1">
<h1><span class="header-section-number">2</span> Modeling</h1>
<div id="dataset-preparation" class="section level2">
<h2><span class="header-section-number">2.1</span> Dataset preparation</h2>
<p>Using the vanilla transaction dataset, we calculated several derived variables for each account as described in the Data Preparation session.</p>
<p>This dataset is joined with Loan, Client, Credit Card, District, Account and Account Balance tables.</p>
<p>We ended up having a dataset with <strong>118 variables</strong>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">loan_dataset_rf &lt;-<span class="st"> </span>source_dataset</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">kable</span>(<span class="kw">tibble</span>(<span class="dt">variables =</span> <span class="kw">names</span>(loan_dataset_rf)))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">variables</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">y_loan_defaulter</td>
</tr>
<tr class="even">
<td align="left">x_account_balance</td>
</tr>
<tr class="odd">
<td align="left">x_average_salary</td>
</tr>
<tr class="even">
<td align="left">x_avg_account_balance</td>
</tr>
<tr class="odd">
<td align="left">x_card_age_month</td>
</tr>
<tr class="even">
<td align="left">x_card_type_classic</td>
</tr>
<tr class="odd">
<td align="left">x_card_type_gold</td>
</tr>
<tr class="even">
<td align="left">x_card_type_junior</td>
</tr>
<tr class="odd">
<td align="left">x_client_age</td>
</tr>
<tr class="even">
<td align="left">x_client_gender_male</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Benesov</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Beroun</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Blansko</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Breclav</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Brno_mesto</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Brno_venkov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Bruntal</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Ceska_Lipa</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Ceske_Budejovice</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Cesky_Krumlov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Cheb</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Chomutov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Chrudim</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Decin</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Domazlice</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Frydek_Mistek</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Havlickuv_Brod</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Hl.m._Praha</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Hodonin</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Hradec_Kralove</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Jablonec_n._Nisou</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Jesenik</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Jicin</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Jihlava</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Jindrichuv_Hradec</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Karlovy_Vary</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Karvina</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Kladno</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Klatovy</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Kolin</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Kromeriz</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Kutna_Hora</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Liberec</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Litomerice</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Louny</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Melnik</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Mlada_Boleslav</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Most</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Nachod</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Novy_Jicin</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Nymburk</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Olomouc</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Opava</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Ostrava_mesto</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Pardubice</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Pelhrimov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Pisek</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Plzen_jih</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Plzen_mesto</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Plzen_sever</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Prachatice</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Praha_vychod</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Praha_zapad</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Prerov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Pribram</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Prostejov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Rakovnik</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Rokycany</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Rychnov_nad_Kneznou</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Semily</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Strakonice</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Sumperk</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Svitavy</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Tabor</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Tachov</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Teplice</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Trebic</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Trutnov</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Uherske_Hradiste</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Usti_nad_Labem</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Usti_nad_Orlici</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Vsetin</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Vyskov</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Zdar_nad_Sazavou</td>
</tr>
<tr class="odd">
<td align="left">x_district_name_Zlin</td>
</tr>
<tr class="even">
<td align="left">x_district_name_Znojmo</td>
</tr>
<tr class="odd">
<td align="left">x_last_transaction_age_days</td>
</tr>
<tr class="even">
<td align="left">x_loan_amount</td>
</tr>
<tr class="odd">
<td align="left">x_loan_duration</td>
</tr>
<tr class="even">
<td align="left">x_loan_payments</td>
</tr>
<tr class="odd">
<td align="left">x_no_of_cities</td>
</tr>
<tr class="even">
<td align="left">x_no_of_commited_crimes_1995</td>
</tr>
<tr class="odd">
<td align="left">x_no_of_commited_crimes_1996</td>
</tr>
<tr class="even">
<td align="left">x_no_of_enterpreneurs_per_1000_inhabitants</td>
</tr>
<tr class="odd">
<td align="left">x_no_of_inhabitants</td>
</tr>
<tr class="even">
<td align="left">x_no_of_municip_2000_to_9999</td>
</tr>
<tr class="odd">
<td align="left">x_no_of_municip_500_to_1999</td>
</tr>
<tr class="even">
<td align="left">x_no_of_municip_greater_10000</td>
</tr>
<tr class="odd">
<td align="left">x_no_of_municip_inhabitants_less_499</td>
</tr>
<tr class="even">
<td align="left">x_prop_household</td>
</tr>
<tr class="odd">
<td align="left">x_prop_insurance_payment</td>
</tr>
<tr class="even">
<td align="left">x_prop_interest_credited</td>
</tr>
<tr class="odd">
<td align="left">x_prop_loan_payment</td>
</tr>
<tr class="even">
<td align="left">x_prop_old_age_pension</td>
</tr>
<tr class="odd">
<td align="left">x_prop_other</td>
</tr>
<tr class="even">
<td align="left">x_prop_statement</td>
</tr>
<tr class="odd">
<td align="left">x_ratio_of_urban_inhabitants</td>
</tr>
<tr class="even">
<td align="left">x_region_central_Bohemia</td>
</tr>
<tr class="odd">
<td align="left">x_region_east_Bohemia</td>
</tr>
<tr class="even">
<td align="left">x_region_north_Bohemia</td>
</tr>
<tr class="odd">
<td align="left">x_region_north_Moravia</td>
</tr>
<tr class="even">
<td align="left">x_region_Prague</td>
</tr>
<tr class="odd">
<td align="left">x_region_south_Bohemia</td>
</tr>
<tr class="even">
<td align="left">x_region_south_Moravia</td>
</tr>
<tr class="odd">
<td align="left">x_transaction_amount</td>
</tr>
<tr class="even">
<td align="left">x_transaction_count</td>
</tr>
<tr class="odd">
<td align="left">x_unemploymant_rate_1995</td>
</tr>
<tr class="even">
<td align="left">x_unemploymant_rate_1996</td>
</tr>
</tbody>
</table>
</div>
<div id="variable-selection" class="section level2">
<h2><span class="header-section-number">2.2</span> Variable selection</h2>
<p>One advantage of Random Forest models is that it does not require heavy feature engineering.</p>
<p>We will only remove <strong>x_prop_old_age_pension</strong> that we know beforehand to have no variance in the dataset.</p>
<p>Mainly beacause of the ramdomness in variable selection of random forest algorithm, this model is not sensible to outliers, missing values and multicollinearity.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">loan_dataset_rf &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(loan_dataset_rf, <span class="op">-</span>x_prop_old_age_pension)</a></code></pre></div>
</div>
<div id="sample-split-into-test-and-training-data" class="section level2">
<h2><span class="header-section-number">2.3</span> Sample split into Test and Training Data</h2>
<p>The available data in Loan Dataset is split into Train and Testing data on the following proportion:</p>
<ul>
<li><strong>Train Dataset</strong> (70% 478 obs);</li>
<li><strong>Test Dataset </strong> (30% 204 obs).</li>
</ul>
<p>We are selecting exact the same samples for all models to allow comparison between then.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">SplitDataset &lt;-<span class="st"> </span>source_train_test_dataset</a>
<a class="sourceLine" id="cb3-2" title="2">data.train_rf &lt;-<span class="st"> </span>SplitDataset<span class="op">$</span>data.train</a>
<a class="sourceLine" id="cb3-3" title="3">data.test_rf &lt;-<span class="st"> </span>SplitDataset<span class="op">$</span>data.test</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">kable</span>(SplitDataset<span class="op">$</span>event.proportion)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">scope</th>
<th align="right">0</th>
<th align="right">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">full dataset</td>
<td align="right">0.8885630</td>
<td align="right">0.1114370</td>
</tr>
<tr class="even">
<td align="left">train dataset</td>
<td align="right">0.8933054</td>
<td align="right">0.1066946</td>
</tr>
<tr class="odd">
<td align="left">test dataset</td>
<td align="right">0.8774510</td>
<td align="right">0.1225490</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">loan_dataset_rf<span class="op">$</span>y_loan_defaulter &lt;-<span class="st"> </span><span class="kw">as.factor</span>(loan_dataset_rf<span class="op">$</span>y_loan_defaulter)</a>
<a class="sourceLine" id="cb4-2" title="2">data.train_rf<span class="op">$</span>y_loan_defaulter   &lt;-<span class="st"> </span><span class="kw">as.factor</span>(data.train_rf<span class="op">$</span>y_loan_defaulter)</a>
<a class="sourceLine" id="cb4-3" title="3">data.test_rf<span class="op">$</span>y_loan_defaulter    &lt;-<span class="st"> </span><span class="kw">as.factor</span>(data.test_rf<span class="op">$</span>y_loan_defaulter)</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">data.train_rf &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(data.train_rf, <span class="kw">names</span>(loan_dataset_rf))</a>
<a class="sourceLine" id="cb4-6" title="6">data.test_rf &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(data.test_rf, <span class="kw">names</span>(loan_dataset_rf))</a></code></pre></div>
<p>Both datasets kept the same proportion for the explained variable at about 11%.</p>
<hr />
</div>
</div>
<div id="selecting-the-best-parameters-values-for-the-random-forest" class="section level1">
<h1><span class="header-section-number">3</span> Selecting the best parameters values for the Random Forest</h1>
<p>The R community is a one of R’s best features. There are many community members doing awesome improvements on existent libraries as well as sharing and spreading knowledge to the four corners of the Earth (if you still think the Earth is flat and square as I do).</p>
<p>Th algorithm selected from <strong>randomForest package</strong> (Please, see <a href="https://ldaniel.github.io/Predictive-Analytics/09_references.html"><strong>References</strong></a> to reach out this amazing package) have two main parameters for random forest algorithm tuning: <strong>mtry</strong> representing the number of variables randomly sampled as candidates at each split (or the size of the trees) and <strong>ntree</strong> representing the number of trees to grow (or the size of the forest).</p>
<p>Another great package for modeling is caret (<em>seriously</em>, check this one out in <a href="https://ldaniel.github.io/Predictive-Analytics/09_references.html"><strong>references</strong></a>, it is fantastic in so many ways!) and, for the sake of our sanity, it has already implemented a good method for randomForest’s package parameter tuning (cheers to them!). This, with the expanded grid search (also from caret package), provides a high performance, friendly and intelligent way of testing parameters. Unfortunately, it is not a perfect world and the implemented method only tune <strong>mtry</strong> parameter.</p>
<p>In order to have both parameters tuned using expanded grid search we need to extend caret’s methodology, creating a custom method for parameter tuning and, for that, even under the risk of being repetitive, we must say: we can be saved by the grace of of R’s community!</p>
<p>There are a lot of implementations accross the internet, however, a good example (and apparently an original one) is provided by Jason Brownlee, who created this customized function supports <strong>mtry</strong> AND <strong>ntree</strong> parameter tuning together. Please, see <a href="https://ldaniel.github.io/Predictive-Analytics/09_references.html"><strong>references</strong></a> page for Jason’s credits (cheers to him!).</p>
<p>Below is his implementation to be further used in our RF training.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">customRF &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">type =</span> <span class="st">&quot;Classification&quot;</span>, <span class="dt">library =</span> <span class="st">&quot;randomForest&quot;</span>, <span class="dt">loop =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">customRF<span class="op">$</span>parameters &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">parameter =</span> <span class="kw">c</span>(<span class="st">&quot;mtry&quot;</span>, <span class="st">&quot;ntree&quot;</span>), </a>
<a class="sourceLine" id="cb5-4" title="4">                                  <span class="dt">class =</span> <span class="kw">rep</span>(<span class="st">&quot;numeric&quot;</span>, <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb5-5" title="5">                                  <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;mtry&quot;</span>, <span class="st">&quot;ntree&quot;</span>))</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">customRF<span class="op">$</span>grid &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">len =</span> <span class="ot">NULL</span>, <span class="dt">search =</span> <span class="st">&quot;grid&quot;</span>) {}</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9">customRF<span class="op">$</span>fit &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, wts, param, lev, last, weights, classProbs, ...) {</a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="kw">randomForest</span>(x, y, <span class="dt">mtry =</span> param<span class="op">$</span>mtry, <span class="dt">ntree=</span>param<span class="op">$</span>ntree, ...)</a>
<a class="sourceLine" id="cb5-11" title="11">}</a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13">customRF<span class="op">$</span>predict &lt;-<span class="st"> </span><span class="cf">function</span>(modelFit, newdata, <span class="dt">preProc =</span> <span class="ot">NULL</span>, <span class="dt">submodels =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb5-14" title="14">  <span class="kw">predict</span>(modelFit, newdata)</a>
<a class="sourceLine" id="cb5-15" title="15"></a>
<a class="sourceLine" id="cb5-16" title="16">customRF<span class="op">$</span>prob &lt;-<span class="st"> </span><span class="cf">function</span>(modelFit, newdata, <span class="dt">preProc =</span> <span class="ot">NULL</span>, <span class="dt">submodels =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb5-17" title="17">  <span class="kw">predict</span>(modelFit, newdata, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)</a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19">customRF<span class="op">$</span>sort &lt;-<span class="st"> </span><span class="cf">function</span>(x) x[<span class="kw">order</span>(x[,<span class="dv">1</span>]),]</a>
<a class="sourceLine" id="cb5-20" title="20"></a>
<a class="sourceLine" id="cb5-21" title="21">customRF<span class="op">$</span>levels &lt;-<span class="st"> </span><span class="cf">function</span>(x) x<span class="op">$</span>classes</a></code></pre></div>
<p>Moving further, we can now set up our expanded grid search using our customized RF train method to test multiple parameters and its different combinations. After that, caret’s method will automatically select best model according to the metric we defined (in our case, accuracy). Moreover, to provide a reliable method of training to avoid (as well as we can) overfitting, we used repeated k-fold cross validation as train control - also provided by caret’s package (we warned you, this is, indeed, an amazing package!).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">control &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">&quot;repeatedcv&quot;</span>, </a>
<a class="sourceLine" id="cb6-2" title="2">                        <span class="dt">number=</span><span class="dv">5</span>, </a>
<a class="sourceLine" id="cb6-3" title="3">                        <span class="dt">repeats=</span><span class="dv">3</span>, </a>
<a class="sourceLine" id="cb6-4" title="4">                        <span class="dt">verboseIter =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb6-5" title="5">                        <span class="dt">allowParallel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">tuneparam &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">.mtry=</span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">85</span>, <span class="dv">100</span>, <span class="dv">115</span>, <span class="dv">125</span>, <span class="dv">150</span>, <span class="dv">175</span>, <span class="dv">200</span>),</a>
<a class="sourceLine" id="cb6-8" title="8">                         <span class="dt">.ntree=</span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, <span class="dv">5000</span>, <span class="dv">7000</span>, <span class="dv">9000</span>, <span class="dv">10000</span>))</a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10">evalmetric &lt;-<span class="st"> &quot;Accuracy&quot;</span></a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb6-13" title="13"></a>
<a class="sourceLine" id="cb6-14" title="14">ini &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb6-15" title="15"><span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Started RF training at: &quot;</span>, ini, <span class="st">&quot; ...</span><span class="ch">\n\n</span><span class="st">&quot;</span>))</a>
<a class="sourceLine" id="cb6-16" title="16"></a>
<a class="sourceLine" id="cb6-17" title="17">rf.full &lt;-<span class="st"> </span><span class="kw">train</span>(y_loan_defaulter <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb6-18" title="18">                 <span class="dt">data=</span>data.train_rf,</a>
<a class="sourceLine" id="cb6-19" title="19">                 <span class="dt">method=</span>customRF,</a>
<a class="sourceLine" id="cb6-20" title="20">                 <span class="dt">metric=</span>evalmetric,</a>
<a class="sourceLine" id="cb6-21" title="21">                 <span class="dt">tuneGrid=</span>tuneparam,</a>
<a class="sourceLine" id="cb6-22" title="22">                 <span class="dt">trControl=</span>control,</a>
<a class="sourceLine" id="cb6-23" title="23">                 <span class="dt">importance=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb6-24" title="24"></a>
<a class="sourceLine" id="cb6-25" title="25">elapsedTime &lt;-<span class="st"> </span><span class="kw">difftime</span>(<span class="kw">Sys.time</span>(), ini, <span class="dt">units =</span> <span class="st">&quot;auto&quot;</span>)</a>
<a class="sourceLine" id="cb6-26" title="26"><span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">Finished RF training. Total time taken: &quot;</span>, <span class="kw">round</span>(elapsedTime, <span class="dv">2</span>), <span class="st">&quot; &quot;</span>, <span class="kw">units</span>(elapsedTime)))</a>
<a class="sourceLine" id="cb6-27" title="27"></a>
<a class="sourceLine" id="cb6-28" title="28"><span class="kw">summary</span>(rf.full)</a>
<a class="sourceLine" id="cb6-29" title="29"><span class="kw">plot</span>(rf.full)</a></code></pre></div>
<p>After some cups of coffee (and maybe some time spent on your preferred streaming provider), we have the training finished. And the winners are…:</p>
<ul>
<li><strong>mtry = 85</strong></li>
<li><strong>ntree = 3000</strong></li>
</ul>
<p>Last but not least, we saved the final model results on disk to be quickly consumed when necessary.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">saveRDS</span>(rf.full, <span class="st">&quot;./models/random_forest.rds&quot;</span>)</a></code></pre></div>
<p>So, to save time, we only have to load the fitted model saved on disk.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">rf.full &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./models/random_forest.rds&quot;</span>)</a></code></pre></div>
<hr />
</div>
<div id="interpreting-model-output" class="section level1">
<h1><span class="header-section-number">4</span> Interpreting model output</h1>
<p>For this model the four principal vars are:</p>
<ul>
<li><strong>x_prop_interest_credited</strong></li>
<li><strong>x_account_balance</strong></li>
<li><strong>x_avg_account_balance</strong></li>
<li><strong>x_loan_amount</strong></li>
</ul>
<p>The result is similar to the Logistic Regression, Decision Tree and Boosting models.</p>
<hr />
</div>
<div id="evaluating-the-model-performance" class="section level1">
<h1><span class="header-section-number">5</span> Evaluating the model performance</h1>
<p>Here we will perform basically the same steps we did in the Logistic Regression, Decision Tree and Boosting models.</p>
<p>A comparison against all the models will be provided in the Final Report session of this exercise.</p>
<p>We started this step by making predictions using our model on the X’s variables in our Train and Test datasets.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co">## making preditions for each model and consolidating in a single data frame</span></a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3">prob.full  =<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb9-4" title="4">prob.train =<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb9-5" title="5">prob.test  =<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7">prob.full<span class="op">$</span>randomforest.actual     &lt;-<span class="st"> </span>loan_dataset_rf<span class="op">$</span>y_loan_defaulter</a>
<a class="sourceLine" id="cb9-8" title="8">prob.full<span class="op">$</span>randomforest.predicted  &lt;-<span class="st"> </span><span class="kw">predict</span>(rf.full, <span class="dt">newdata =</span> loan_dataset_rf, </a>
<a class="sourceLine" id="cb9-9" title="9">                                             <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11">prob.train<span class="op">$</span>randomforest.actual    &lt;-<span class="st"> </span>data.train_rf<span class="op">$</span>y_loan_defaulter</a>
<a class="sourceLine" id="cb9-12" title="12">prob.train<span class="op">$</span>randomforest.predicted &lt;-<span class="st"> </span><span class="kw">predict</span>(rf.full, <span class="dt">newdata =</span> data.train_rf, </a>
<a class="sourceLine" id="cb9-13" title="13">                                             <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15">prob.test<span class="op">$</span>randomforest.actual     &lt;-<span class="st"> </span>data.test_rf<span class="op">$</span>y_loan_defaulter</a>
<a class="sourceLine" id="cb9-16" title="16">prob.test<span class="op">$</span>randomforest.predicted  &lt;-<span class="st"> </span><span class="kw">predict</span>(rf.full, <span class="dt">newdata =</span> data.test_rf, </a>
<a class="sourceLine" id="cb9-17" title="17">                                             <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-18" title="18"></a>
<a class="sourceLine" id="cb9-19" title="19">prob.full  &lt;-<span class="st"> </span>prob.full <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb9-20" title="20">prob.train &lt;-<span class="st"> </span>prob.train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb9-21" title="21">prob.test  &lt;-<span class="st"> </span>prob.test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a></code></pre></div>
<div id="getting-performance-measures" class="section level2">
<h2><span class="header-section-number">5.1</span> Getting Performance Measures</h2>
<p>To calculate the performance measures, derived from the confusion matrix, we need to find the score cut off that best split our test dataset into Defaulters and Non-Defaulters.</p>
<p>In this exercise we decide to not prioritize the accuracy on predicting Defaulters and Non-Defaulters, therefore we are looking for the score cut off that best predict each class equally.</p>
<p>With the returned object from this function we can plot the comparison between TPR (True Positive Rate) and TNR (True Negative Rate) to find the best cut off.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co">## getting measures -----------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb10-2" title="2">metricsByCutoff.test_randomforest  &lt;-<span class="st"> </span><span class="kw">modelMetrics</span>(prob.test<span class="op">$</span>randomforest.actual, </a>
<a class="sourceLine" id="cb10-3" title="3">                                                   prob.test<span class="op">$</span>randomforest.predicted, </a>
<a class="sourceLine" id="cb10-4" title="4">                                                   <span class="dt">plot_title =</span> <span class="st">&#39;Random Forest&#39;</span>)</a>
<a class="sourceLine" id="cb10-5" title="5">metricsByCutoff.test_randomforest<span class="op">$</span>Plot</a></code></pre></div>
<div id="htmlwidget-cade0a2f86882513d043" style="width:100%;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-cade0a2f86882513d043">{"x":{"visdat":{"47842b692e41":["function () ","plotlyVisDat"]},"cur_data":"47842b692e41","attrs":{"47842b692e41":{"x":{},"y":{},"opacity":0.3,"name":"Abs. Diff.","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"bar"},"47842b692e41.1":{"x":{},"y":{},"opacity":1,"name":"TPR","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","mode":"lines","inherit":true},"47842b692e41.2":{"x":{},"y":{},"opacity":1,"name":"TNR","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","mode":"lines","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"Cutoff Value"},"yaxis":{"domain":[0,1],"automargin":true,"title":"True Ratio (%)"},"annotations":[{"text":"<b>Random Forest<\/b>","x":0,"y":1.04,"yref":"paper","xref":"paper","xanchor":"left","yanchor":"top","showarrow":false,"font":{"size":15}},{"text":"<b>0.12<\/b>","x":0.12,"y":0.76,"showarrow":false,"bgcolor":"white","opacity":0.8}],"hovermode":"closest","showlegend":true},"source":"A","config":{"showSendToCloud":false},"data":[{"x":[0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.1,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.2,0.21,0.22,0.23,0.24,0.25,0.26,0.27,0.28,0.29,0.3,0.31,0.32,0.33,0.34,0.35,0.36,0.37,0.38,0.39,0.4,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.5,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.6,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.7,0.71,0.72,0.73,0.74,0.75,0.76,0.77,0.78],"y":[0.747709497206704,0.647150837988827,0.529832402234637,0.462793296089385,0.361340782122905,0.33340782122905,0.288715083798883,0.255195530726257,0.227262569832402,0.0969832402234636,0.0858100558659217,0.010949720670391,0.016536312849162,0.0621229050279329,0.153296089385475,0.18122905027933,0.249162011173184,0.260335195530726,0.305921787709497,0.317094972067039,0.36268156424581,0.368268156424581,0.430614525139665,0.436201117318436,0.476201117318436,0.527374301675978,0.532960893854749,0.572960893854749,0.62413407821229,0.62413407821229,0.629720670391061,0.629720670391061,0.686480446927374,0.686480446927374,0.686480446927374,0.697653631284916,0.703240223463687,0.708826815642458,0.708826815642458,0.748826815642458,0.754413407821229,0.754413407821229,0.794413407821229,0.794413407821229,0.794413407821229,0.834413407821229,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.84,0.88,0.88,0.88,0.88,0.88,0.88,0.88,0.88,0.88,0.88,0.88,0.92,0.96,0.96,0.96,0.96,0.96],"opacity":0.3,"name":"Abs. Diff.","type":"bar","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.1,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.2,0.21,0.22,0.23,0.24,0.25,0.26,0.27,0.28,0.29,0.3,0.31,0.32,0.33,0.34,0.35,0.36,0.37,0.38,0.39,0.4,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.5,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.6,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.7,0.71,0.72,0.73,0.74,0.75,0.76,0.77,0.78],"y":[0.96,0.96,0.96,0.96,0.92,0.92,0.92,0.92,0.92,0.84,0.84,0.76,0.76,0.72,0.64,0.64,0.6,0.6,0.56,0.56,0.52,0.52,0.48,0.48,0.44,0.4,0.4,0.36,0.32,0.32,0.32,0.32,0.28,0.28,0.28,0.28,0.28,0.28,0.28,0.24,0.24,0.24,0.2,0.2,0.2,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.16,0.12,0.12,0.12,0.12,0.12,0.12,0.12,0.12,0.12,0.12,0.12,0.08,0.04,0.04,0.04,0.04,0.04],"opacity":1,"name":"TPR","type":"scatter","mode":"lines","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.1,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.2,0.21,0.22,0.23,0.24,0.25,0.26,0.27,0.28,0.29,0.3,0.31,0.32,0.33,0.34,0.35,0.36,0.37,0.38,0.39,0.4,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.5,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.6,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.7,0.71,0.72,0.73,0.74,0.75,0.76,0.77,0.78],"y":[0.212290502793296,0.312849162011173,0.430167597765363,0.497206703910615,0.558659217877095,0.58659217877095,0.631284916201117,0.664804469273743,0.692737430167598,0.743016759776536,0.754189944134078,0.770949720670391,0.776536312849162,0.782122905027933,0.793296089385475,0.82122905027933,0.849162011173184,0.860335195530726,0.865921787709497,0.877094972067039,0.88268156424581,0.888268156424581,0.910614525139665,0.916201117318436,0.916201117318436,0.927374301675978,0.932960893854749,0.932960893854749,0.94413407821229,0.94413407821229,0.949720670391061,0.949720670391061,0.966480446927374,0.966480446927374,0.966480446927374,0.977653631284916,0.983240223463687,0.988826815642458,0.988826815642458,0.988826815642458,0.994413407821229,0.994413407821229,0.994413407821229,0.994413407821229,0.994413407821229,0.994413407821229,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"opacity":1,"name":"TNR","type":"scatter","mode":"lines","marker":{"color":"rgba(44,160,44,1)","line":{"color":"rgba(44,160,44,1)"}},"error_y":{"color":"rgba(44,160,44,1)"},"error_x":{"color":"rgba(44,160,44,1)"},"line":{"color":"rgba(44,160,44,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>With the optimized cut off we calculate the full set of model metrics using the function HMeasure from hmeasure library (another very good package! Don’t forget to check for our <a href="https://ldaniel.github.io/Predictive-Analytics/09_references.html"><strong>references</strong></a>).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># Random Forest</span></a>
<a class="sourceLine" id="cb11-2" title="2">measures.randomforest.train &lt;-<span class="st"> </span><span class="kw">HMeasure</span>(prob.train<span class="op">$</span>randomforest.actual, </a>
<a class="sourceLine" id="cb11-3" title="3">                                        prob.train<span class="op">$</span>randomforest.predicted, </a>
<a class="sourceLine" id="cb11-4" title="4">                                        <span class="dt">threshold =</span> metricsByCutoff.test_randomforest<span class="op">$</span>BestCut[<span class="st">&#39;Cut&#39;</span>])</a>
<a class="sourceLine" id="cb11-5" title="5">measures.randomforest.test  &lt;-<span class="st"> </span><span class="kw">HMeasure</span>(prob.test<span class="op">$</span>randomforest.actual, </a>
<a class="sourceLine" id="cb11-6" title="6">                                        prob.test<span class="op">$</span>randomforest.predicted, </a>
<a class="sourceLine" id="cb11-7" title="7">                                        <span class="dt">threshold =</span> metricsByCutoff.test_randomforest<span class="op">$</span>BestCut[<span class="st">&#39;Cut&#39;</span>])</a>
<a class="sourceLine" id="cb11-8" title="8"></a>
<a class="sourceLine" id="cb11-9" title="9"></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co"># join measures in a single data frame</span></a>
<a class="sourceLine" id="cb11-11" title="11">measures &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">bind_rows</span>(measures.randomforest.train<span class="op">$</span>metrics,</a>
<a class="sourceLine" id="cb11-12" title="12">                        measures.randomforest.test<span class="op">$</span>metrics</a>
<a class="sourceLine" id="cb11-13" title="13">                        )) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>(., <span class="dt">rownames =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb11-14" title="14"></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="kw">colnames</span>(measures) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;random forest - train&#39;</span>, <span class="st">&#39;random forest - test&#39;</span>)</a>
<a class="sourceLine" id="cb11-16" title="16"></a>
<a class="sourceLine" id="cb11-17" title="17">measures<span class="op">$</span>metric =<span class="st"> </span><span class="kw">rownames</span>(measures)</a>
<a class="sourceLine" id="cb11-18" title="18"></a>
<a class="sourceLine" id="cb11-19" title="19">measures &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(measures, metric, <span class="kw">everything</span>())</a></code></pre></div>
<p>Below are the metrics on the train and test dataset:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">kable</span>(measures, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">metric</th>
<th align="right">random forest - train</th>
<th align="right">random forest - test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">H</td>
<td align="right">1.0000000</td>
<td align="right">0.4248541</td>
</tr>
<tr class="even">
<td align="left">Gini</td>
<td align="right">1.0000000</td>
<td align="right">0.6808939</td>
</tr>
<tr class="odd">
<td align="left">AUC</td>
<td align="right">1.0000000</td>
<td align="right">0.8404469</td>
</tr>
<tr class="even">
<td align="left">AUCH</td>
<td align="right">1.0000000</td>
<td align="right">0.8654749</td>
</tr>
<tr class="odd">
<td align="left">KS</td>
<td align="right">1.0000000</td>
<td align="right">0.6239106</td>
</tr>
<tr class="even">
<td align="left">MER</td>
<td align="right">0.0000000</td>
<td align="right">0.0980392</td>
</tr>
<tr class="odd">
<td align="left">MWL</td>
<td align="right">0.0000000</td>
<td align="right">0.0808824</td>
</tr>
<tr class="even">
<td align="left">Spec.Sens95</td>
<td align="right">1.0000000</td>
<td align="right">0.5139665</td>
</tr>
<tr class="odd">
<td align="left">Sens.Spec95</td>
<td align="right">1.0000000</td>
<td align="right">0.3200000</td>
</tr>
<tr class="even">
<td align="left">ER</td>
<td align="right">0.0460251</td>
<td align="right">0.2303922</td>
</tr>
<tr class="odd">
<td align="left">Sens</td>
<td align="right">1.0000000</td>
<td align="right">0.7600000</td>
</tr>
<tr class="even">
<td align="left">Spec</td>
<td align="right">0.9484778</td>
<td align="right">0.7709497</td>
</tr>
<tr class="odd">
<td align="left">Precision</td>
<td align="right">0.6986301</td>
<td align="right">0.3166667</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="right">1.0000000</td>
<td align="right">0.7600000</td>
</tr>
<tr class="odd">
<td align="left">TPR</td>
<td align="right">1.0000000</td>
<td align="right">0.7600000</td>
</tr>
<tr class="even">
<td align="left">FPR</td>
<td align="right">0.0515222</td>
<td align="right">0.2290503</td>
</tr>
<tr class="odd">
<td align="left">F</td>
<td align="right">0.8225806</td>
<td align="right">0.4470588</td>
</tr>
<tr class="even">
<td align="left">Youden</td>
<td align="right">0.9484778</td>
<td align="right">0.5309497</td>
</tr>
<tr class="odd">
<td align="left">TP</td>
<td align="right">51.0000000</td>
<td align="right">19.0000000</td>
</tr>
<tr class="even">
<td align="left">FP</td>
<td align="right">22.0000000</td>
<td align="right">41.0000000</td>
</tr>
<tr class="odd">
<td align="left">TN</td>
<td align="right">405.0000000</td>
<td align="right">138.0000000</td>
</tr>
<tr class="even">
<td align="left">FN</td>
<td align="right">0.0000000</td>
<td align="right">6.0000000</td>
</tr>
</tbody>
</table>
<p>Our RF model clearly overfitted (as we can see by most of metrics, AUC of 1.0 in train set and 0.84 in test set, for example). This happened mainly because of the size of our dataset.</p>
</div>
<div id="evaluating-classification-performance" class="section level2">
<h2><span class="header-section-number">5.2</span> Evaluating classification performance</h2>
<p>This model delivered an amazing result but not the best one (beaten by the boosting model). We have a full session to compare how it performed against other models in the Final Report session. But wait, you should’t hurry, there are still some steps to evaluate RF algorithm.</p>
<p>Below the confusion matrix and general performance of the model:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co"># accuracy metrics ---------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co"># random forest</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">accuracy</span>(<span class="dt">score =</span> prob.test<span class="op">$</span>randomforest.predicted, </a>
<a class="sourceLine" id="cb13-4" title="4">         <span class="dt">actual =</span> prob.test<span class="op">$</span>randomforest.actual, </a>
<a class="sourceLine" id="cb13-5" title="5">         <span class="dt">threshold =</span> metricsByCutoff.test_randomforest[[<span class="st">&quot;BestCut&quot;</span>]][[<span class="st">&quot;Cut&quot;</span>]])</a></code></pre></div>
<pre><code>## 
## 
##             pred.1   pred.0
## ---------  -------  -------
## actual.1        19        6
## actual.0        41      138
## [1] &quot;--------------------------------------------------------------&quot;
## [1] &quot;Model General Accuracy of: 76.96%&quot;
## [1] &quot;True Positive Rate of    : 76%&quot;</code></pre>
<p>We finally look at the score distribution charts to check how well the model is able to discriminate Defaulters and Non-Defaulters.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">p1 &lt;-<span class="st"> </span><span class="kw">Score_Histograms</span>(prob.test, </a>
<a class="sourceLine" id="cb15-2" title="2">                 prob.test<span class="op">$</span>randomforest.predicted,</a>
<a class="sourceLine" id="cb15-3" title="3">                 prob.test<span class="op">$</span>randomforest.actual,</a>
<a class="sourceLine" id="cb15-4" title="4">                 <span class="st">&#39;Density Plot&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.title.y =</span> <span class="kw">element_blank</span>())</a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6">p2 &lt;-<span class="st"> </span><span class="kw">Score_Boxplot</span>(prob.test, </a>
<a class="sourceLine" id="cb15-7" title="7">              prob.test<span class="op">$</span>randomforest.predicted, </a>
<a class="sourceLine" id="cb15-8" title="8">              prob.test<span class="op">$</span>randomforest.actual,</a>
<a class="sourceLine" id="cb15-9" title="9">              <span class="st">&#39;Score Boxplot&#39;</span>)</a>
<a class="sourceLine" id="cb15-10" title="10"></a>
<a class="sourceLine" id="cb15-11" title="11">p3 &lt;-<span class="st">   </span><span class="kw">KS_Plot</span>(prob.test<span class="op">$</span>randomforest.predicted[prob.test<span class="op">$</span>randomforest.actual <span class="op">==</span><span class="st"> </span><span class="dv">0</span>],</a>
<a class="sourceLine" id="cb15-12" title="12">          prob.test<span class="op">$</span>randomforest.predicted[prob.test<span class="op">$</span>randomforest.actual <span class="op">==</span><span class="st"> </span><span class="dv">1</span>],</a>
<a class="sourceLine" id="cb15-13" title="13">          <span class="st">&#39;Random Forest&#39;</span>)</a>
<a class="sourceLine" id="cb15-14" title="14"></a>
<a class="sourceLine" id="cb15-15" title="15"><span class="kw">ggarrange</span>(p1, p2, <span class="dt">nrow =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="07_random_forest_report_files/figure-html/model_plots-1.png" width="100%" /></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">p3</a></code></pre></div>
<p><img src="07_random_forest_report_files/figure-html/model_plots-2.png" width="100%" /></p>
<p>By the score density we see that our Random Forest model provides a narrow and precise discrimination around defaulters.</p>
<p>The box plot also shows a clear discrimination between Defaulters and Non-Defaulters.</p>
<p>Finally, the KS metric is also presented a good result for a reliable classification purpose.</p>
<p>In the Final Report session, we will look more closely on the AUC and Gini metrics by plotting the ROC curve and comparing against other models.</p>
<p>Stay tuned!!!</p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
